# 开发日志

# 区块链开发文档  
**版本：v0.2.0**  
**更新周期：2025/04/03 ~ 2025/04/06**

---

## 🚀 核心功能概览  

### 1. **加密与签名模块** (`math_util.py`)  
- **功能亮点**  
  - **密钥生成工具** (`GenerateKeysUtils`):  
    - 生成符合比特币标准的随机私钥（32字节）  
    - 压缩公钥转换（SECP256k1曲线）  
    - 基于公钥计算比特币地址（Base58Check编码）  
  - **交易签名工具** (`SignMessageUtils`):  
    - 确定性ECDSA签名（RFC 6979），确保相同输入生成唯一签名  
  - **验证工具集** (`VerifyHashAndSignatureUtils`):  
    - P2PKH脚本解锁逻辑（支持锁定/解锁脚本验证）  
    - 签名有效性验证（兼容压缩/非压缩公钥）  

- **代码规模**  
  ```plaintext
  总行数：300行  
  核心方法：密钥生成、签名、验证三合一流水线  

---

### 2. **交易池与交易类**  
- **Mempool 模块**  
  - 功能特性：  
    - 交易去重、内存管理（默认10MB容量）  
    - 手续费优先级排序（按 fee/byte 动态淘汰低费交易）  
    - RBF交易替换（需提高手续费）  
  - 代码规模：  
    ```plaintext
    250行（不含挖矿逻辑）  
    支持与UTXO管理器协同工作  
    ```

- **Transaction 类** (`transactions.py`)  
  - 核心结构：  
    ```python
    class Transaction:
        vins: List[txInput]   # 交易输入（引用UTXO）
        vouts: List[txOutput] # 交易输出（锁定到地址）
        Txid: str             # 交易唯一标识（双重SHA256哈希）
        fee: int              # 动态手续费（基于交易字节数）
    ```
  - 特色功能：  
    - Coinbase交易生成（矿工奖励，需100区块确认）  
    - 交易序列化/反序列化（兼容比特币格式）  

---

### 3. **节点架构设计**  
- **节点类型**  
  | 类型      | 功能描述                         | 状态   |
  | --------- | -------------------------------- | ------ |
  | Full Node | 完整区块链验证与存储             | 开发中 |
  | Miner     | 动态PoW挖矿与交易打包            | 已完成 |
  | SPV Node  | 轻量级交易验证（依赖Merkle证明） | 未实现 |

- **组件依赖**  
  ```mermaid
  graph TD
    Node --> Network_Interface(P2P通信 & API)
    Node --> Blockchain(本地区块链数据)
    Node --> Mempool_UTXO(交易池 & UTXO管理)
    Node --> Storage(LevelDB/Redis/MongoDB)
  ```

---

### 4. **存储方案**  
- **LevelDB**  
  - 用途：存储区块链原始数据（持久化到磁盘）  
- **Redis**  
  - 用途：缓存链状态（高度、节点列表、邻居列表）  
- **MongoDB**  
  - 用途：UTXO交易池管理（待实现）  

---

## 🛠 问题修复与优化  
| 日期     | 问题描述                      | 修复方案                   |
| -------- | ----------------------------- | -------------------------- |
| 2025/4/3 | Transaction类变量命名不规范   | 重构为`txInput`/`txOutput` |
| 2025/4/4 | 公钥哈希生成不符合比特币规范  | 改用Base58Check编码        |
| 2025/4/4 | ECDSA签名随机性导致兼容性问题 | 强制使用RFC 6979确定性签名 |

---

## ⚠️ 已知问题与待优化  
1. **输入验证不足**  
   - 风险：未校验超大金额、无效签名、重复交易  
   - 改进方向：添加格式检查（如地址有效性、Txid唯一性）  

2. **存储模块待完善**  
   - MongoDB UTXO池未实现  
   - LevelDB与Redis的同步机制需设计  

3. **网络层未完成**  
   - P2P通信和区块广播逻辑待开发  

---

## 🔮 未来计划  
- **安全增强**  
  - 实现交易输入的边界检查（防整数溢出）  
  - 引入BIP32分层确定性钱包  
- **性能优化**  
  - 支持Compact Block Relay（降低带宽消耗）  
  - 实现UTXO Commitments（快速状态验证）  
- **部署方案**  
  - 提供Docker镜像简化环境配置  

---

**文档生成时间：2025/04/06**  

```
```
